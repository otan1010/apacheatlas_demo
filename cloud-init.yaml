#cloud-config
package_update: true
packages:
  - ca-certificates
  - curl
  - gnupg

runcmd:
  # Install Docker (official repo)
  - install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  - chmod a+r /etc/apt/keyrings/docker.gpg
  - >
    bash -lc 'echo
    "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg]
    https://download.docker.com/linux/ubuntu
    $(. /etc/os-release && echo $VERSION_CODENAME) stable"
    > /etc/apt/sources.list.d/docker.list'
  - apt-get update -y
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

  # Create an atlas folder and docker-compose.yml
  - mkdir -p /opt/atlas
  - |
    cat > /opt/atlas/docker-compose.yml <<'EOF'
    services:
      atlas:
        image: sburn/apache-atlas:2.3.0
        container_name: atlas
        ports:
          - "21000:21000"
        environment:
          - ATLAS_SERVER_OPTS=-Xms2g -Xmx4g
        volumes:
          - atlas_data:/var/lib/atlas
        restart: unless-stopped

    volumes:
      atlas_data:
    EOF

  # Start Atlas
  - bash -lc 'cd /opt/atlas && docker compose up -d'
